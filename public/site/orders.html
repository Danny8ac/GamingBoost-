<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GamingBoost ‚Ä¢ Mis pedidos</title>
  <link rel="stylesheet" href="styles.css?v=2"/>
</head>
<body>

<div class="container">

  <div class="nav">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div>GamingBoost</div>
        <div class="small">Mis pedidos</div>
      </div>
    </div>

    <div class="navlinks">
      <a class="btn" href="index.html">Inicio</a>
      <a class="btn" href="catalog.html">Cat√°logo</a>
      <button class="btn danger" id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="row" style="justify-content:space-between; align-items:flex-start;">
      <div>
        <h2 style="margin:0;">Mis pedidos</h2>
        <div class="muted" style="margin-top:6px;">Aqu√≠ ves tus pedidos como en la app.</div>
      </div>
      <div class="row">
        <button class="btn" id="reloadBtn">Recargar</button>
      </div>
    </div>

    <div id="msg" class="small" style="margin-top:10px;"></div>
  </div>

  <div id="list" class="list" style="margin-top:12px;"></div>

</div>

<script>
  const token = localStorage.getItem("gb_token");
  if (!token) location.href = "login.html";

  const msg = document.getElementById("msg");
  const list = document.getElementById("list");

  document.getElementById("logoutBtn").onclick = async () => {
    try {
      await fetch(location.origin + "/api/logout", {
        method: "POST",
        headers: { "Accept":"application/json", "Authorization": "Bearer " + token }
      });
    } catch {}
    localStorage.removeItem("gb_token");
    localStorage.removeItem("gb_user");
    location.href = "index.html";
  };

  document.getElementById("reloadBtn").onclick = () => loadOrders();

  function addParam(url, key, value){
    const sep = url.includes("?") ? "&" : "?";
    return url + sep + encodeURIComponent(key) + "=" + encodeURIComponent(value);
  }

  function badgeHtml(status){
    if (status === "paid") return `<span class="badge ok">‚úÖ Pagado</span>`;
    if (status === "pending_payment") return `<span class="badge warn">üü° Pendiente</span>`;
    if (status === "cancelled") return `<span class="badge bad">‚ùå Cancelado</span>`;
    if (status === "failed") return `<span class="badge bad">‚ö†Ô∏è Fallido</span>`;
    return `<span class="badge">${escapeHtml(status)}</span>`;
  }

  function moneyMXNFromCents(cents){
    const v = (cents ?? 0) / 100;
    return new Intl.NumberFormat("es-MX", { style:"currency", currency:"MXN" }).format(v);
  }

  async function loadOrders(){
    msg.textContent = "Cargando pedidos‚Ä¶";
    list.innerHTML = "";

    const res = await fetch(location.origin + "/api/orders", {
      headers: { "Accept": "application/json", "Authorization": "Bearer " + token }
    });

    const text = await res.text();
    let orders = [];
    try { orders = text ? JSON.parse(text) : []; } catch(e){
      msg.textContent = "‚ùå Error: respuesta inv√°lida del servidor";
      console.error(text);
      return;
    }

    if (!res.ok){
      msg.textContent = `‚ùå Error cargando pedidos (${res.status})`;
      console.error(orders);
      return;
    }

    if (!Array.isArray(orders) || orders.length === 0){
      msg.textContent = "";
      list.innerHTML = `<div class="item">A√∫n no tienes pedidos.</div>`;
      return;
    }

    msg.textContent = "";

    // Backend viene newest -> oldest. Para "Pedido #1 = el primero creado"
    list.innerHTML = orders.map((o, idx) => {
      const userNumber = orders.length - idx; // #1 = m√°s viejo
      const canContinue = o.status === "pending_payment";

      return `
        <div class="item">
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div style="font-weight:950; font-size:1.08rem;">Pedido #${userNumber}</div>
              <div class="small">ID interno: #${o.id} ‚Ä¢ ${escapeHtml(o.provider)} ‚Ä¢ ${escapeHtml(o.currency)}</div>
            </div>
            ${badgeHtml(o.status)}
          </div>

          <div class="hr"></div>

          <div class="row" style="justify-content:space-between;">
            <div class="small">${(o.items?.length ?? 0)} items</div>
            <div class="badge">Total ${moneyMXNFromCents(o.total_amount)}</div>
          </div>

          <div class="small" style="margin-top:10px;">
            ${(o.items || []).map(it => `‚Ä¢ Boost ${it.boost_id} x${it.qty}`).join("<br/>")}
          </div>

          ${canContinue ? `
            <div class="row" style="margin-top:12px; justify-content:flex-end;">
              <button class="btn primary" id="cont-${o.id}" onclick="continuePay(${o.id})">
                Continuar pago
              </button>
            </div>
          ` : ``}
        </div>
      `;
    }).join("");
  }

  async function continuePay(orderId){
    const btn = document.getElementById(`cont-${orderId}`);
    if (btn){ btn.disabled = true; btn.textContent = "Abriendo‚Ä¶"; }
    msg.textContent = "Abriendo pasarela‚Ä¶";

    const res = await fetch(location.origin + `/api/orders/${orderId}/pay`, {
      method: "POST",
      headers: { "Accept": "application/json", "Authorization": "Bearer " + token }
    });

    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch {}

    if (!res.ok || !data?.checkout_url){
      msg.textContent = `‚ùå No se pudo abrir checkout (${res.status})`;
      console.error(text);
      if (btn){ btn.disabled = false; btn.textContent = "Continuar pago"; }
      return;
    }

    window.location.href = addParam(data.checkout_url, "from", "web");
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  loadOrders();
</script>

</body>
</html>